# Клиент API Честного Знака

Это клиент на языке Java для взаимодействия с API Честного Знака, предназначенный для создания документов ввода товаров в оборот с ограничением количества запросов и потокобезопасной аутентификацией.

## Возможности

Класс `CrptApi` реализует следующие требования:
- **Реализация класса**: `CrptApi` с конструктором `CrptApi(TimeUnit timeUnit, int requestLimit)` для задания лимита запросов в заданный интервал времени (например, секунды, минуты).
- **Потокобезопасность**: Достигается с помощью `ReentrantLock` для синхронизации, `AtomicInteger` для подсчета запросов и `volatile` для видимости токена аутентификации между потоками.
- **Ограничение запросов**: Реализовано через внутренний класс `RateLimiter`, который блокирует запросы при превышении лимита, обеспечивая соблюдение `requestLimit`.
- **Создание документа**: Метод `createDocument(Document document, String signature)` создает документ для ввода товаров, произведенных в РФ, в оборот, используя JSON-сериализацию и двухэтапную аутентификацию.
- **Библиотеки**: Используется `HttpClient` (из `java.net.http`) для HTTP-запросов и Jackson (`jackson-databind`) для сериализации/десериализации JSON.
- **Единый файл**: Весь код, включая внутренние классы (`RateLimiter`, `Document`, `Product`, `AuthKeyResponse`, `AuthTokenRequest`, `AuthTokenResponse`, `ApiException`), содержится в `CrptApi.java`.
- **Тестирование**: Полный набор юнит-тестов в `CrptApiTest.java`, покрывающий ограничение запросов, успешное создание документа, обработку ошибок (например, HTTP 400) и многопоточный доступ.

**Примечание о заглушках**:
- Метод `signData` в `CrptApi` использует заглушку (кодирование Base64) в качестве временной замены для генерации цифровой подписи (УКЭП). В продакшене этот метод должен быть заменен на использование соответствующей библиотеки УКЭП (например, CryptoPro) для соответствия требованиям API Честного Знака.

## Требования

Для сборки и тестирования проекта убедитесь, что установлены:
- **Java 17** (рекомендуется 17; Java 11 совместима, но может потребовать корректировки зависимостей).
- **Maven 3.9.9** или выше.
- **IntelliJ IDEA** или другая IDE.

## Инструкции по настройке

1. **Клонирование репозитория**:
   ```bash
   git clone https://github.com/mlk-R/crpt
   cd crpt
   ```

2. **Настройка Java 17**:
   - Убедитесь, что Java 17 установлена. Проверьте с помощью:

3. **Установка зависимостей Maven**:
   - Перейдите в директорию проекта и выполните:
     ```bash
     mvn clean install
     ```
   - Это загрузит все зависимости, указанные в `pom.xml`, включая Spring Boot 3.3.5, Jackson и Mockito.

## Запуск тестов

Проект включает юнит-тесты для класса `CrptApi`, проверяющие ограничение запросов, создание документов, обработку ошибок и многопоточный доступ.

1. **Выполнение тестов**:
   - Выполните следующую команду для запуска всех тестов:
     ```bash
     mvn test
     ```
   - Ожидаемый результат:
     ```
     [INFO] Tests run: 5, Failures: 0, Errors: 0, Skipped: 0
     [INFO] BUILD SUCCESS
     ```
   - Это подтверждает, что все тесты (`testRateLimiter`, `testSuccessfulDocumentCreation`, `testFailedDocumentCreation`, `testConcurrentAccess` и `CrptApplicationTests`) успешно пройдены.

2. **Устранение неполадок**:
   - При проблемах с зависимостями очистите кэш Maven:
     ```bash
     mvn dependency:purge-local-repository
     mvn clean install
     ```
   - Если тесты не проходят из-за версии Java, убедитесь, что используется Java 17:
     ```bash
     export JAVA_HOME=/path/to/jdk-17
     mvn test
     ```

## Как использовать CrptApi.java

### Использование

Класс `CrptApi` предназначен для взаимодействия с API Честного Знака для создания документов. Вот как его использовать:

1. **Создание экземпляра клиента**:
   ```java
   import java.util.concurrent.TimeUnit;
   CrptApi crptApi = new CrptApi(TimeUnit.SECONDS, 2); // 2 запроса в секунду
   ```

2. **Создание документа**:
   - Подготовьте объект `Document` с необходимыми полями и списком объектов `Product`.
   - Укажите подпись в виде строки (в данный момент заглушка; в продакшене замените на реальную УКЭП).
   ```java
   import java.util.List;
   List<CrptApi.Product> products = List.of(
       new CrptApi.Product("CONFORMITY_CERTIFICATE", "2023-01-01", "12345", "0104650117240408211dmfcZNcM")
   );
   CrptApi.Document document = new CrptApi.Document("1234567890", "2023-01-01", products);
   try {
       crptApi.createDocument(document, "fakeSignature");
       System.out.println("Документ успешно создан");
   } catch (Exception e) {
       System.err.println("Ошибка при создании документа: " + e.getMessage());
   }
   ```

3. **Потокобезопасность**:
   - Класс является потокобезопасным, поэтому один экземпляр можно использовать в нескольких потоках. `RateLimiter` гарантирует соблюдение лимита запросов, а аутентификация синхронизирована.

### Расширение функциональности

- **Добавление новых методов API**: Расширьте `CrptApi`, добавив новые методы (например, для запроса статуса документа), используя существующие `HttpClient` и `objectMapper`.
- **Реальная УКЭП**: Замените заглушку `signData` на библиотеку для цифровой подписи (CryptoPro), изменив метод `signData`.
- **Кастомизация ограничений**: Измените класс `RateLimiter` для поддержки других стратегий ограничения (например, token bucket).

### Детали заглушки

Единственная заглушка в реализации находится в методе `signData`:
```java
private String signData(String data) {
    if (data == null) {
        throw new IllegalArgumentException("Data for signing cannot be null");
    }
    return java.util.Base64.getEncoder().encodeToString(data.getBytes());
}
```
- **Назначение**: Имитирует генерацию цифровой подписи (УКЭП), необходимой для аутентификации.
- **Ограничение**: Кодирование Base64 не является действительной заменой криптографической подписи.
- **Необходимые действия**: В продакшене замените на библиотеку, CryptoPro. Обновите метод для интеграции с API библиотеки для подписи данных.

## Примечания

- Проект использует имитацию подписи (кодирование Base64) для аутентификации. В продакшене интегрируйте библиотеку УКЭП (например, CryptoPro).
- Тесты используют рефлексию для внедрения замоканного `HttpClient`. Для упрощения тестирования рассмотрите добавление конструктора в `CrptApi` для прямой передачи `HttpClient`:
  ```java
  public CrptApi(TimeUnit timeUnit, int requestLimit, HttpClient httpClient) {
      this.httpClient = httpClient != null ? httpClient : HttpClient.newBuilder().build();
      this.objectMapper = new ObjectMapper();
      this.rateLimiter = new RateLimiter(timeUnit, requestLimit);
  }
  ```
- Если вы предпочитаете использовать `RestTemplate` вместо `HttpClient`, проект можно переработать, так как зависимость `spring-boot-starter-web` уже включена.

## Контакты

По вопросам или проблемам обращайтесь:
- **Телефон**: +7 (988) 631-70-10
- **Email**: malikmagomedgajiev@yandex.ru